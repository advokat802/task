{% extends "base.html" %}

{% block title %}–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">üìã –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrganizationModal">
            <i class="bi bi-plus-circle me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é
        </button>
    </div>

    <!-- –ü–æ–∏—Å–∫ -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-8">
                    <input type="text" class="form-control" name="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –£–ù–ü, –Ω–∞–∑–≤–∞–Ω–∏—é, –∞–¥—Ä–µ—Å—É..." value="{{ search_query }}">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-outline-primary w-100">
                        <i class="bi bi-search me-2"></i>–ù–∞–π—Ç–∏
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π -->
    <div class="card">
        <div class="card-body">
            {% if organizations %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</th>
                            <th>–£–ù–ü</th>
                            <th>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</th>
                            <th>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for org in organizations %}
                        <tr>
                            <td>
                                <strong>{{ org.short_name }}</strong>
                                {% if org.phone or org.email %}
                                <br>
                                <small class="text-muted">
                                    {% if org.phone %}{{ org.phone }}{% endif %}
                                    {% if org.email %} | {{ org.email }}{% endif %}
                                </small>
                                {% endif %}
                            </td>
                            <td><code>{{ org.unp }}</code></td>
                            <td>{{ org.legal_address or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</td>
                            <td>{{ org.director or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary btn-edit-org" 
                                            data-bs-toggle="modal" data-bs-target="#editOrganizationModal"
                                            data-id="{{ org.id }}"
                                            data-unp="{{ org.unp }}"
                                            data-short-name="{{ org.short_name or '' }}"
                                            data-legal-address="{{ org.legal_address or '' }}"
                                            data-actual-address="{{ org.actual_address or '' }}"
                                            data-phone="{{ org.phone or '' }}"
                                            data-email="{{ org.email or '' }}"
                                            data-director="{{ org.director or '' }}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    {% if user.role == 'manager' %}
                                    <button type="button" class="btn btn-outline-danger btn-delete-org" 
                                            data-id="{{ org.id }}" 
                                            data-name="{{ org.short_name }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-building fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h5>
                <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –ø–æ–∏—Å–∫–∞</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
<div class="modal fade" id="addOrganizationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addOrganizationForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">–£–ù–ü *</label>
                            <input type="text" class="form-control" name="unp" required maxlength="9" pattern="\d{9}">
                            <div class="form-text">9 —Ü–∏—Ñ—Ä</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ *</label>
                            <input type="text" class="form-control" name="short_name" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
                            <textarea class="form-control" name="legal_address" rows="2"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
                            <textarea class="form-control" name="actual_address" rows="2"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                            <input type="tel" class="form-control" name="phone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                        <div class="col-12">
                            <label class="form-label">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</label>
                            <input type="text" class="form-control" name="director">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveOrganization()">
                    <i class="bi bi-check-lg me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
<div class="modal fade" id="editOrganizationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editOrganizationForm">
                    <input type="hidden" name="org_id" id="editOrgId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">–£–ù–ü *</label>
                            <input type="text" class="form-control" name="unp" id="editUnp" required maxlength="9" pattern="\d{9}" readonly>
                            <div class="form-text">–£–ù–ü –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ *</label>
                            <input type="text" class="form-control" name="short_name" id="editShortName" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
                            <textarea class="form-control" name="legal_address" id="editLegalAddress" rows="2"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
                            <textarea class="form-control" name="actual_address" id="editActualAddress" rows="2"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                            <input type="tel" class="form-control" name="phone" id="editPhone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="editEmail">
                        </div>
                        <div class="col-12">
                            <label class="form-label">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</label>
                            <input type="text" class="form-control" name="director" id="editDirector">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="updateOrganization()">
                    <i class="bi bi-check-lg me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
function saveOrganization() {
    console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏...');
    
    const form = document.getElementById('addOrganizationForm');
    const formData = new FormData(form);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    const unp = formData.get('unp');
    const shortName = formData.get('short_name');
    
    if (!unp || unp.length !== 9) {
        alert('–£–ù–ü –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 9 —Ü–∏—Ñ—Ä');
        return;
    }
    
    if (!shortName) {
        alert('–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
        return;
    }

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    const btn = document.querySelector('#addOrganizationModal .btn-primary');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    fetch('/create_organization', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            const modal = bootstrap.Modal.getInstance(document.getElementById('addOrganizationModal'));
            modal.hide();
            location.reload();
        } else {
            alert('‚ùå ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-lg me-2"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-lg me-2"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
function updateOrganization() {
    console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏...');
    
    const form = document.getElementById('editOrganizationForm');
    const formData = new FormData(form);
    const orgId = document.getElementById('editOrgId').value;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    const shortName = document.getElementById('editShortName').value.trim();
    
    if (!shortName) {
        alert('–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
        return;
    }

    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', {
        org_id: orgId,
        short_name: shortName,
        legal_address: formData.get('legal_address'),
        actual_address: formData.get('actual_address'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        director: formData.get('director')
    });
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
    const btn = document.querySelector('#editOrganizationModal .btn-primary');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    
    // –°–æ–∑–¥–∞–µ–º URLSearchParams –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–ë–ï–ó –£–ù–ü, —Ç–∞–∫ –∫–∞–∫ –æ–Ω readonly)
    const params = new URLSearchParams();
    params.append('org_id', orgId);
    params.append('short_name', shortName);
    params.append('legal_address', formData.get('legal_address') || '');
    params.append('actual_address', formData.get('actual_address') || '');
    params.append('phone', formData.get('phone') || '');
    params.append('email', formData.get('email') || '');
    params.append('director', formData.get('director') || '');
    
    fetch('/edit_organization_full/' + orgId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: params
    })
    .then(response => response.json())
    .then(response => {
        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response);
        if (response.success) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            const modal = bootstrap.Modal.getInstance(document.getElementById('editOrganizationModal'));
            modal.hide();
            location.reload();
        } else {
            alert('‚ùå ' + response.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-lg me-2"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-lg me-2"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function fillEditForm(button) {
    console.log('–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...');
    
    const orgId = button.getAttribute('data-id');
    const unp = button.getAttribute('data-unp');
    const shortName = button.getAttribute('data-short-name');
    const legalAddress = button.getAttribute('data-legal-address');
    const actualAddress = button.getAttribute('data-actual-address');
    const phone = button.getAttribute('data-phone');
    const email = button.getAttribute('data-email');
    const director = button.getAttribute('data-director');

    console.log('–î–∞–Ω–Ω—ã–µ –∏–∑ –∫–Ω–æ–ø–∫–∏:', { 
        orgId, unp, shortName, legalAddress, actualAddress, phone, email, director 
    });

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('editOrgId').value = orgId || '';
    document.getElementById('editUnp').value = unp || '';
    document.getElementById('editShortName').value = shortName || '';
    document.getElementById('editLegalAddress').value = legalAddress || '';
    document.getElementById('editActualAddress').value = actualAddress || '';
    document.getElementById('editPhone').value = phone || '';
    document.getElementById('editEmail').value = email || '';
    document.getElementById('editDirector').value = director || '';
    
    console.log('–§–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –£–ù–ü
    document.querySelectorAll('input[name="unp"]').forEach(input => {
        input.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').slice(0, 9);
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.querySelectorAll('.btn-edit-org').forEach(button => {
        button.addEventListener('click', function() {
            console.log('–ö–ª–∏–∫ –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é');
            fillEditForm(this);
        });
    });

    // –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
    document.querySelectorAll('.btn-delete-org').forEach(button => {
        button.addEventListener('click', function() {
            const orgId = this.getAttribute('data-id');
            const orgName = this.getAttribute('data-name');
            
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é "${orgName}"?`)) {
                fetch('/delete_organization/' + orgId, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(response => {
                    if (response.success) {
                        alert('‚úÖ ' + response.message);
                        location.reload();
                    } else {
                        alert('‚ùå ' + response.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
                });
            }
        });
    });

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    document.getElementById('addOrganizationModal').addEventListener('hidden.bs.modal', function () {
        document.getElementById('addOrganizationForm').reset();
    });
});
</script>
{% endblock %}