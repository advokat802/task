{% extends "base.html" %}

{% block title %}Документы - Task Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="bi bi-files"></i>
            {% if document_type == 'act' %}Акты
            {% elif document_type == 'invoice' %}Счета
            {% else %}Все документы{% endif %}
        </h2>
        
        <!-- Кнопка создания документа доступна ВСЕМ пользователям -->
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDocumentModal">
            <i class="bi bi-plus-circle"></i> Создать документ
        </button>
    </div>

    <!-- Фильтры -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <!-- Фильтр по типу документа -->
                <div class="col-md-4">
                    <label class="form-label fw-bold">Тип документа:</label>
                    <div class="btn-group w-100" role="group">
                        <a href="{{ url_for('documents_page', show_sent=show_sent) }}" 
                           class="btn btn-{{ 'primary' if document_type == 'all' else 'outline-primary' }}">
                            Все
                        </a>
                        <a href="{{ url_for('documents_page', type='act', show_sent=show_sent) }}" 
                           class="btn btn-{{ 'info' if document_type == 'act' else 'outline-info' }}">
                            <i class="bi bi-file-text"></i> Акты
                        </a>
                        <a href="{{ url_for('documents_page', type='invoice', show_sent=show_sent) }}" 
                           class="btn btn-{{ 'warning' if document_type == 'invoice' else 'outline-warning' }}">
                            <i class="bi bi-receipt"></i> Счета
                        </a>
                    </div>
                </div>

                <!-- Фильтр по статусу -->
                <div class="col-md-4">
                    <label class="form-label fw-bold">Статус документов:</label>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showSentToggle" 
                               {% if show_sent %}checked{% endif %}
                               onchange="toggleSent()">
                        <label class="form-check-label" for="showSentToggle">
                            {% if show_sent %}
                            <span class="text-success">Показаны отправленные</span>
                            {% else %}
                            <span class="text-muted">Только черновики</span>
                            {% endif %}
                        </label>
                    </div>
                </div>

                <!-- Информация -->
                <div class="col-md-4">
                    <label class="form-label fw-bold">Статистика:</label>
                    <div class="text-muted">
                        <small>
                            Всего: <strong>{{ documents|length }}</strong>
                            {% if document_type == 'all' %}
                            | Акты: <strong class="text-info">{{ documents|selectattr('document_type', 'equalto', 'act')|list|length }}</strong>
                            | Счета: <strong class="text-warning">{{ documents|selectattr('document_type', 'equalto', 'invoice')|list|length }}</strong>
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Таблица документов -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Список документов</h5>
            <div class="text-muted">
                <small>Показано: <strong>{{ documents|length }}</strong> документов</small>
            </div>
        </div>
        <div class="card-body">
            {% if documents %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Номер</th>
                            <th>Тип</th>
                            <th>Клиент</th>
                            <th>Организация</th>
                            <th>Сумма</th>
                            <th>Дата</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in documents %}
                        <tr>
                            <td>
                                <strong>{{ doc.document_number }}</strong>
                                {% if doc.description %}
                                <br><small class="text-muted">{{ doc.description[:30] }}...</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'info' if doc.document_type == 'act' else 'warning' }}">
                                    {% if doc.document_type == 'act' %}Акт{% else %}Счет{% endif %}
                                </span>
                            </td>
                            <td>{{ doc.client_name }}</td>
                            <td>
                                {% if doc.client_organization %}
                                <span class="badge bg-light text-dark border">
                                    {{ doc.client_organization }}
                                </span>
                                {% else %}
                                <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ "%.2f"|format(doc.amount) }} ₽</strong>
                            </td>
                            <td>{{ doc.document_date }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if doc.status == 'sent' else 'secondary' }}">
                                    {% if doc.status == 'draft' %}Черновик{% else %}Отправлен{% endif %}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <!-- Кнопка просмотра для всех -->
                                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#documentDetailsModal"
                                            data-document-id="{{ doc.id }}"
                                            data-document-type="{{ doc.document_type }}"
                                            data-document-number="{{ doc.document_number }}"
                                            data-client-name="{{ doc.client_name }}"
                                            data-client-organization="{{ doc.client_organization }}"
                                            data-client-phone="{{ doc.client_phone }}"
                                            data-client-email="{{ doc.client_email }}"
                                            data-client-address="{{ doc.client_address }}"
                                            data-amount="{{ doc.amount }}"
                                            data-description="{{ doc.description }}"
                                            data-status="{{ doc.status }}"
                                            data-document-date="{{ doc.document_date }}"
                                            data-created-by="{{ doc.created_by_username }}">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    
                                    <!-- Кнопки редактирования и удаления только для менеджеров -->
                                    {% if user.role == 'manager' %}
                                    <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#editDocumentModal"
                                            data-document-id="{{ doc.id }}"
                                            data-document-data='{{ doc | tojson }}'>
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    
                                    <form method="POST" action="{{ url_for('delete_document_route', document_id=doc.id) }}" 
                                          class="d-inline" onsubmit="return confirm('Удалить этот документ?')">
                                        <button type="submit" class="btn btn-outline-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-folder-x fs-1"></i>
                <p class="mt-2">Документы не найдены</p>
                <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#createDocumentModal">
                    <i class="bi bi-plus-circle"></i> Создать первый документ
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно создания документа -->
<div class="modal fade" id="createDocumentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Создать новый документ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_document_route') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Тип документа *</label>
                                <select name="document_type" class="form-select" required>
                                    <option value="act">Акт выполненных работ</option>
                                    <option value="invoice">Счет на оплату</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Сумма *</label>
                                <input type="number" step="0.01" name="amount" class="form-control" placeholder="0.00" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Имя клиента *</label>
                                <input type="text" name="client_name" class="form-control" placeholder="ФИО клиента" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Телефон *</label>
                                <input type="tel" name="client_phone" class="form-control" placeholder="+7 XXX XXX-XX-XX" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Организация *</label>
                                <select name="client_organization" class="form-select" id="docOrganizationSelect" required>
                                    <option value="">-- Выберите организацию --</option>
                                    <!-- Организации будут загружены через AJAX -->
                                </select>
                                <input type="text" name="client_organization_custom" class="form-control mt-2" placeholder="Или введите новую организацию" id="docCustomOrganizationInput" style="display: none;">
                                <div class="form-text">
                                    <small>Выберите из списка или введите новую</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" name="client_email" class="form-control" placeholder="email@example.com">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Адрес</label>
                                <input type="text" name="client_address" class="form-control" placeholder="Адрес клиента">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Описание</label>
                        <textarea name="description" class="form-control" rows="3" placeholder="Описание работ или услуг..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Создать документ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно деталей документа -->
<div class="modal fade" id="documentDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-text"></i> Детали документа
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Номер документа</label>
                            <p id="detail-doc-number" class="form-control-plaintext"></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Тип документа</label>
                            <p id="detail-doc-type" class="form-control-plaintext"></p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Статус</label>
                            <p id="detail-doc-status" class="form-control-plaintext"></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Дата</label>
                            <p id="detail-doc-date" class="form-control-plaintext"></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Сумма</label>
                            <p id="detail-doc-amount" class="form-control-plaintext"></p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Описание</label>
                    <p id="detail-doc-description" class="form-control-plaintext"></p>
                </div>
                
                <hr>
                <h6 class="fw-bold">Информация о клиенте</h6>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Имя клиента</label>
                            <p id="detail-client-name" class="form-control-plaintext"></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Телефон</label>
                            <p id="detail-client-phone" class="form-control-plaintext"></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Организация</label>
                            <p id="detail-client-org" class="form-control-plaintext"></p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Email</label>
                            <p id="detail-client-email" class="form-control-plaintext"></p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Адрес</label>
                            <p id="detail-client-address" class="form-control-plaintext"></p>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Создан</label>
                            <p id="detail-created-by" class="form-control-plaintext"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования документа (только для менеджеров) -->
{% if user.role == 'manager' %}
<div class="modal fade" id="editDocumentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil"></i> Редактировать документ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editDocumentForm" method="POST" action="#">
                <div class="modal-body">
                    <input type="hidden" id="edit-doc-id" name="document_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Номер документа</label>
                                <p id="edit-doc-number" class="form-control-plaintext fw-bold"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Тип документа</label>
                                <p id="edit-doc-type" class="form-control-plaintext"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Статус *</label>
                                <select id="edit-doc-status" name="status" class="form-select" required>
                                    <option value="draft">Черновик</option>
                                    <option value="sent">Отправлен</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Сумма *</label>
                                <input type="number" step="0.01" id="edit-doc-amount" name="amount" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Дата</label>
                                <p id="edit-doc-date" class="form-control-plaintext"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Описание</label>
                        <textarea id="edit-doc-description" name="description" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <hr>
                    <h6 class="fw-bold">Информация о клиенте</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Имя клиента *</label>
                                <input type="text" id="edit-client-name" name="client_name" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Телефон *</label>
                                <input type="text" id="edit-client-phone" name="client_phone" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Организация *</label>
                                <select id="edit-client-org-select" name="client_organization" class="form-select" required>
                                    <option value="">-- Выберите организацию --</option>
                                    <!-- Организации будут загружены через AJAX -->
                                </select>
                                <input type="text" id="edit-client-org-input" name="client_organization_custom" class="form-control mt-2" placeholder="Или введите новую организацию" style="display: none;">
                                <div class="form-text">
                                    <small>Выберите из списка или введите новую</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Email</label>
                                <input type="email" id="edit-client-email" name="client_email" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Адрес</label>
                                <input type="text" id="edit-client-address" name="client_address" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
.btn-group .btn {
    border-radius: 0.375rem;
    margin: 0 1px;
}
.table th {
    background-color: #2c3e50;
    color: white;
}
.badge {
    font-size: 0.75em;
}
.form-control-plaintext {
    min-height: 24px;
    padding: 6px 0;
    border-bottom: 1px solid #e9ecef;
}
</style>

<script>
function toggleSent() {
    const showSent = document.getElementById('showSentToggle').checked;
    const url = new URL(window.location.href);
    url.searchParams.set('show_sent', showSent);
    window.location.href = url.toString();
}

// Загрузка организаций для документов
document.addEventListener('DOMContentLoaded', function() {
    // Загружаем организации для создания документа
    loadOrganizationsForDocuments();

    // Переключение между выпадающим списком и текстовым полем
    const docOrgSelect = document.getElementById('docOrganizationSelect');
    const docCustomOrgInput = document.getElementById('docCustomOrganizationInput');
    
    if (docOrgSelect && docCustomOrgInput) {
        docOrgSelect.addEventListener('change', function() {
            if (this.value === '') {
                docCustomOrgInput.style.display = 'block';
                docCustomOrgInput.required = true;
            } else {
                docCustomOrgInput.style.display = 'none';
                docCustomOrgInput.required = false;
                docCustomOrgInput.value = '';
            }
        });
    }

    // Автоматическое закрытие алертов
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);

    // Обработка модального окна деталей документа
    const docDetailButtons = document.querySelectorAll('[data-bs-target="#documentDetailsModal"]');
    docDetailButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const docNumber = this.getAttribute('data-document-number');
            const docType = this.getAttribute('data-document-type');
            const clientName = this.getAttribute('data-client-name');
            const clientOrg = this.getAttribute('data-client-organization') || '—';
            const clientPhone = this.getAttribute('data-client-phone');
            const clientEmail = this.getAttribute('data-client-email') || '—';
            const clientAddress = this.getAttribute('data-client-address') || '—';
            const amount = this.getAttribute('data-amount');
            const description = this.getAttribute('data-description') || '—';
            const status = this.getAttribute('data-status');
            const docDate = this.getAttribute('data-document-date');
            const createdBy = this.getAttribute('data-created-by');

            // Заполняем модальное окно
            document.getElementById('detail-doc-number').textContent = docNumber;
            document.getElementById('detail-doc-type').innerHTML = docType === 'act' ? 
                '<span class="badge bg-info">Акт выполненных работ</span>' : 
                '<span class="badge bg-warning">Счет на оплату</span>';
            document.getElementById('detail-doc-status').innerHTML = status === 'draft' ? 
                '<span class="badge bg-secondary">Черновик</span>' : 
                '<span class="badge bg-success">Отправлен</span>';
            document.getElementById('detail-doc-date').textContent = docDate;
            document.getElementById('detail-doc-amount').textContent = parseFloat(amount).toFixed(2) + ' ₽';
            document.getElementById('detail-doc-description').textContent = description;
            document.getElementById('detail-client-name').textContent = clientName;
            document.getElementById('detail-client-phone').textContent = clientPhone;
            document.getElementById('detail-client-org').textContent = clientOrg;
            document.getElementById('detail-client-email').textContent = clientEmail;
            document.getElementById('detail-client-address').textContent = clientAddress;
            document.getElementById('detail-created-by').textContent = createdBy || '—';
        });
    });

    // Обработка модального окна редактирования документа (только для менеджеров)
    {% if user.role == 'manager' %}
    const editDocButtons = document.querySelectorAll('[data-bs-target="#editDocumentModal"]');
    editDocButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const docData = JSON.parse(this.getAttribute('data-document-data'));
            
            // Заполняем форму редактирования
            document.getElementById('edit-doc-id').value = docData.id;
            document.getElementById('edit-doc-number').textContent = docData.document_number;
            document.getElementById('edit-doc-type').innerHTML = docData.document_type === 'act' ? 
                '<span class="badge bg-info">Акт выполненных работ</span>' : 
                '<span class="badge bg-warning">Счет на оплату</span>';
            document.getElementById('edit-doc-status').value = docData.status;
            document.getElementById('edit-doc-amount').value = docData.amount;
            document.getElementById('edit-doc-date').textContent = docData.document_date;
            document.getElementById('edit-doc-description').value = docData.description || '';
            document.getElementById('edit-client-name').value = docData.client_name;
            document.getElementById('edit-client-phone').value = docData.client_phone;
            
            // Загружаем организации для выпадающего списка в редактировании
            loadOrganizationsForEditModal().then(() => {
                const orgSelect = document.getElementById('edit-client-org-select');
                if (orgSelect) {
                    orgSelect.value = docData.client_organization || '';
                    
                    // Если организации нет в списке, показываем текстовое поле
                    if (!orgSelect.value && docData.client_organization) {
                        document.getElementById('edit-client-org-input').style.display = 'block';
                        document.getElementById('edit-client-org-input').value = docData.client_organization;
                    }
                }
            });
            
            document.getElementById('edit-client-email').value = docData.client_email || '';
            document.getElementById('edit-client-address').value = docData.client_address || '';
        });
    });

    // Обработка переключения между выпадающим списком и текстовым полем в редактировании
    const editOrgSelect = document.getElementById('edit-client-org-select');
    const editOrgInput = document.getElementById('edit-client-org-input');
    
    if (editOrgSelect && editOrgInput) {
        editOrgSelect.addEventListener('change', function() {
            if (this.value === '') {
                editOrgInput.style.display = 'block';
                editOrgInput.required = true;
            } else {
                editOrgInput.style.display = 'none';
                editOrgInput.required = false;
                editOrgInput.value = '';
            }
        });
    }

    // Обработка формы редактирования документа
    const editDocForm = document.getElementById('editDocumentForm');
    if (editDocForm) {
        editDocForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const docId = formData.get('document_id');
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Показываем индикатор загрузки
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Сохранение...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(`/edit_document_full/${docId}`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('✓ ' + (data.message || 'Изменения сохранены успешно!'), 'success');
                    
                    // Закрываем модальное окно и перезагружаем страницу
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editDocumentModal'));
                    modal.hide();
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                    
                } else {
                    throw new Error(data.error || 'Неизвестная ошибка сервера');
                }
                
            } catch (error) {
                console.error('Ошибка при сохранении:', error);
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                showAlert('❌ Ошибка сохранения: ' + error.message, 'danger');
            }
        });
    }
    {% endif %}

    // Функция для показа алертов
    function showAlert(message, type) {
        const existingAlerts = document.querySelectorAll('.alert-dismissible');
        existingAlerts.forEach(alert => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                const bsAlert = new bootstrap.Alert(alertDiv);
                bsAlert.close();
            }
        }, 5000);
    }
});

// Функция загрузки организаций для создания документа
function loadOrganizationsForDocuments() {
    const orgSelect = document.getElementById('docOrganizationSelect');
    if (!orgSelect) return;

    fetch('/get_organizations_json')
        .then(response => response.json())
        .then(organizations => {
            organizations.forEach(org => {
                const option = document.createElement('option');
                option.value = org.short_name || org.full_name;
                option.textContent = org.short_name ? `${org.short_name} (УНП: ${org.unp})` : org.full_name;
                orgSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Ошибка при загрузке организаций:', error);
        });
}

// Функция загрузки организаций для модального окна редактирования
function loadOrganizationsForEditModal() {
    return new Promise((resolve, reject) => {
        const orgSelect = document.getElementById('edit-client-org-select');
        if (!orgSelect) {
            resolve();
            return;
        }

        // Очищаем существующие опции (кроме первой)
        while (orgSelect.options.length > 1) {
            orgSelect.remove(1);
        }

        fetch('/get_organizations_json')
            .then(response => response.json())
            .then(organizations => {
                organizations.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org.short_name || org.full_name;
                    option.textContent = org.short_name ? `${org.short_name} (УНП: ${org.unp})` : org.full_name;
                    orgSelect.appendChild(option);
                });
                resolve();
            })
            .catch(error => {
                console.error('Ошибка при загрузке организаций:', error);
                reject(error);
            });
    });
}
</script>
{% endblock %}